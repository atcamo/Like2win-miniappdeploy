<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üéØ Test Sistema de Engagement - Like2Win</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #FEF3C7, #F59E0B);
            min-height: 100vh;
        }
        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 15px 35px rgba(0,0,0,0.1);
        }
        .title {
            color: #F59E0B;
            font-size: 32px;
            font-weight: bold;
            text-align: center;
            margin-bottom: 30px;
        }
        .section {
            background: #F9FAFB;
            border: 2px solid #E5E7EB;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
        }
        .section.success {
            border-color: #10B981;
            background: #ECFDF5;
        }
        .section.warning {
            border-color: #F59E0B;
            background: #FFFBEB;
        }
        .section.error {
            border-color: #EF4444;
            background: #FEF2F2;
        }
        button {
            background: #F59E0B;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
            margin: 10px 5px;
        }
        button:hover {
            background: #D97706;
        }
        button.secondary {
            background: #6B7280;
        }
        button.secondary:hover {
            background: #4B5563;
        }
        .result {
            background: #F3F4F6;
            padding: 15px;
            border-radius: 6px;
            font-family: monospace;
            font-size: 12px;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
            margin: 10px 0;
        }
        .grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        .status {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
        }
        .status.active {
            background: #DCFCE7;
            color: #166534;
        }
        .status.inactive {
            background: #FEE2E2;
            color: #991B1B;
        }
        input, select {
            padding: 8px 12px;
            border: 1px solid #D1D5DB;
            border-radius: 4px;
            margin: 5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="title">üéØ Sistema de Detecci√≥n de Likes</div>
        
        <div class="section">
            <h3>üìä Estado del Sistema</h3>
            <p><strong>Periodo de Rifa Activo:</strong> <span class="status active">13 enero - 26 enero 2025</span></p>
            <p><strong>Detecci√≥n Autom√°tica:</strong> <span id="detection-status" class="status">Verificando...</span></p>
            <p><strong>Base de Datos:</strong> <span id="db-status" class="status">Verificando...</span></p>
            
            <button onclick="checkSystemStatus()">üîç Verificar Estado</button>
            <button onclick="checkActiveRaffle()" class="secondary">üìÖ Ver Rifa Activa</button>
        </div>

        <div class="section">
            <h3>üß™ Simular Evento de Like</h3>
            <p>Simula que un usuario hace like a un post oficial durante el periodo de rifa:</p>
            
            <div>
                <label>FID del Usuario:</label>
                <input type="text" id="user-fid" value="12345" placeholder="FID del usuario">
                
                <label>Cast Hash:</label>
                <input type="text" id="cast-hash" value="" placeholder="Hash del cast (opcional)">
                
                <label>Timestamp:</label>
                <select id="timestamp-option">
                    <option value="now">Ahora (tiempo actual)</option>
                    <option value="raffle-start">Inicio de rifa (13 enero)</option>
                    <option value="raffle-end">Final de rifa (26 enero)</option>
                    <option value="before-raffle">Antes de rifa (inv√°lido)</option>
                    <option value="after-raffle">Despu√©s de rifa (inv√°lido)</option>
                </select>
            </div>
            
            <button onclick="simulateLike()">üëç Simular Like</button>
            <button onclick="simulateMultipleLikes()" class="secondary">üë• Simular 5 Likes</button>
            
            <div id="simulation-result" class="result" style="display: none;"></div>
        </div>

        <div class="grid">
            <div class="section">
                <h3>üìà Antes del Like</h3>
                <button onclick="checkUserTicketsBefore()">üìä Ver Tickets Actuales</button>
                <div id="before-result" class="result" style="display: none;"></div>
            </div>
            
            <div class="section">
                <h3>üìà Despu√©s del Like</h3>
                <button onclick="checkUserTicketsAfter()">üìä Ver Tickets Actualizados</button>
                <div id="after-result" class="result" style="display: none;"></div>
            </div>
        </div>

        <div class="section">
            <h3>üìã Log de Engagement</h3>
            <button onclick="viewEngagementLog()">üìú Ver Historial</button>
            <button onclick="clearLogs()" class="secondary">üóëÔ∏è Limpiar Logs</button>
            <div id="engagement-log" class="result" style="display: none;"></div>
        </div>

        <div class="section warning">
            <h3>‚ö†Ô∏è Configuraci√≥n para Producci√≥n</h3>
            <p><strong>Para detectar likes reales, necesitas:</strong></p>
            <ol>
                <li>Configurar webhook de Neynar en: <code>/api/webhooks/neynar</code></li>
                <li>Suscribirte a eventos de "reaction.created" para tu cast/usuario</li>
                <li>Actualizar FID oficial de @Like2Win en el c√≥digo</li>
                <li>Configurar NEYNAR_API_KEY en variables de entorno</li>
            </ol>
            <button onclick="showWebhookInfo()">üîó Ver Info de Webhook</button>
        </div>

        <div id="webhook-info" class="section" style="display: none;">
            <h3>üîó Informaci√≥n del Webhook</h3>
            <div id="webhook-details" class="result"></div>
        </div>
    </div>

    <script>
        const BASE_URL = 'https://like2win-miniappdeploy.vercel.app';
        let userFid = '12345';
        
        // Auto-check status on load
        document.addEventListener('DOMContentLoaded', function() {
            checkSystemStatus();
            userFid = document.getElementById('user-fid').value;
        });
        
        async function checkSystemStatus() {
            try {
                // Check database connection
                const dbResponse = await fetch(`${BASE_URL}/api/debug-db`);
                const dbData = await dbResponse.json();
                
                document.getElementById('db-status').textContent = dbData.success ? 'Conectada' : 'Error';
                document.getElementById('db-status').className = 'status ' + (dbData.success ? 'active' : 'inactive');
                
                // Check engagement endpoint
                const engagementResponse = await fetch(`${BASE_URL}/api/engagement/process`);
                const engagementData = await engagementResponse.json();
                
                document.getElementById('detection-status').textContent = engagementResponse.ok ? 'Funcionando' : 'Error';
                document.getElementById('detection-status').className = 'status ' + (engagementResponse.ok ? 'active' : 'inactive');
                
            } catch (error) {
                console.error('Error checking status:', error);
                document.getElementById('db-status').textContent = 'Error';
                document.getElementById('detection-status').textContent = 'Error';
            }
        }
        
        async function checkActiveRaffle() {
            try {
                const response = await fetch(`${BASE_URL}/api/debug-db`);
                const data = await response.json();
                
                if (data.raffle_data) {
                    alert(`‚úÖ Rifa Activa Encontrada:
ID: ${data.raffle_data.id}
Periodo: ${data.raffle_data.weekPeriod}
Inicio: ${new Date(data.raffle_data.startDate).toLocaleString()}
Fin: ${new Date(data.raffle_data.endDate).toLocaleString()}
Total Tickets: ${data.raffle_data.totalTickets}
Participantes: ${data.raffle_data.totalParticipants}`);
                } else {
                    alert('‚ùå No se encontr√≥ rifa activa');
                }
            } catch (error) {
                alert('Error verificando rifa activa: ' + error.message);
            }
        }
        
        async function simulateLike() {
            userFid = document.getElementById('user-fid').value;
            const castHash = document.getElementById('cast-hash').value || `cast_${Date.now()}`;
            const timestampOption = document.getElementById('timestamp-option').value;
            
            let timestamp;
            switch(timestampOption) {
                case 'now':
                    timestamp = new Date().toISOString();
                    break;
                case 'raffle-start':
                    timestamp = '2025-01-13T00:00:00Z';
                    break;
                case 'raffle-end':
                    timestamp = '2025-01-26T23:59:59Z';
                    break;
                case 'before-raffle':
                    timestamp = '2025-01-12T23:59:59Z';
                    break;
                case 'after-raffle':
                    timestamp = '2025-01-27T00:00:00Z';
                    break;
            }
            
            try {
                const response = await fetch(`${BASE_URL}/api/engagement/process`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        type: 'like',
                        userFid: userFid,
                        castHash: castHash,
                        timestamp: timestamp
                    })
                });
                
                const result = await response.json();
                
                document.getElementById('simulation-result').style.display = 'block';
                document.getElementById('simulation-result').innerHTML = `Resultado de Simulaci√≥n:
Status: ${response.status}
Success: ${result.success}
Message: ${result.message}
${result.data ? `
Tickets Otorgados: ${result.data.ticketsAwarded}
Total Tickets: ${result.data.totalTickets}
Usuario: ${result.data.userFid}
Procesado: ${result.data.processedAt}` : ''}

Timestamp usado: ${timestamp}
Cast Hash: ${castHash}

Full Response:
${JSON.stringify(result, null, 2)}`;
                
                console.log('Simulation result:', result);
                
            } catch (error) {
                document.getElementById('simulation-result').style.display = 'block';
                document.getElementById('simulation-result').textContent = `Error: ${error.message}`;
            }
        }
        
        async function simulateMultipleLikes() {
            const results = [];
            for (let i = 0; i < 5; i++) {
                const testFid = (parseInt(userFid) + i).toString();
                document.getElementById('user-fid').value = testFid;
                await simulateLike();
                await new Promise(resolve => setTimeout(resolve, 500)); // Wait 500ms between requests
            }
        }
        
        async function checkUserTicketsBefore() {
            userFid = document.getElementById('user-fid').value;
            try {
                const response = await fetch(`${BASE_URL}/api/raffle/status-real?fid=${userFid}`);
                const data = await response.json();
                
                document.getElementById('before-result').style.display = 'block';
                document.getElementById('before-result').innerHTML = `Tickets Antes del Like:
Usuario FID: ${userFid}
Tickets Actuales: ${data.data?.user?.currentTickets || 0}
Probabilidad: ${data.data?.user?.probability || 0}%
Total en Raffle: ${data.data?.raffle?.totalTickets || 0}

${JSON.stringify(data.data?.user, null, 2)}`;
                
            } catch (error) {
                document.getElementById('before-result').style.display = 'block';
                document.getElementById('before-result').textContent = `Error: ${error.message}`;
            }
        }
        
        async function checkUserTicketsAfter() {
            await checkUserTicketsBefore(); // Reuse the same function but update the 'after' section
            const beforeContent = document.getElementById('before-result').innerHTML;
            document.getElementById('after-result').style.display = 'block';
            document.getElementById('after-result').innerHTML = beforeContent.replace('Antes del Like', 'Despu√©s del Like');
        }
        
        async function viewEngagementLog() {
            // This would require a new API endpoint to view engagement logs
            document.getElementById('engagement-log').style.display = 'block';
            document.getElementById('engagement-log').innerHTML = `Log de Engagement:
Esta funci√≥n requiere implementar un endpoint adicional para consultar 
la tabla engagement_log.

Para ver logs manualmente:
1. Ve a Supabase ‚Üí SQL Editor
2. Ejecuta: SELECT * FROM engagement_log ORDER BY "createdAt" DESC LIMIT 10;

Pr√≥xima implementaci√≥n: /api/engagement/log`;
        }
        
        function clearLogs() {
            if (confirm('¬øLimpiar todos los logs de engagement? Esto eliminar√° el historial.')) {
                alert('Funci√≥n de limpieza pendiente de implementaci√≥n');
            }
        }
        
        async function showWebhookInfo() {
            try {
                const response = await fetch(`${BASE_URL}/api/webhooks/neynar`);
                const data = await response.json();
                
                document.getElementById('webhook-info').style.display = 'block';
                document.getElementById('webhook-details').innerHTML = `Informaci√≥n del Webhook:
${JSON.stringify(data, null, 2)}

URL del Webhook: ${BASE_URL}/api/webhooks/neynar

Para configurar en Neynar:
1. Ve a Neynar Dashboard
2. Webhooks ‚Üí Create New
3. URL: ${BASE_URL}/api/webhooks/neynar
4. Events: reaction.created, cast.mentioned
5. Filters: Solo casts de @Like2Win oficial`;
                
            } catch (error) {
                document.getElementById('webhook-info').style.display = 'block';
                document.getElementById('webhook-details').textContent = `Error: ${error.message}`;
            }
        }
    </script>
</body>
</html>